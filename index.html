<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>致乖乖 - 爱的粒子特效</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== 基础样式 ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* ========== 加载器 ========== */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ff2e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loader-text {
            font-size: 1.2rem;
            color: #ffafcc;
            animation: pulse 2s infinite;
        }
        
        .loader-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .loader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff2e63, #ff9a00);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ========== 粒子背景 ========== */
        #particles-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* ========== 主容器 ========== */
        .container {
            position: relative;
            z-index: 2;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        /* ========== 标题 ========== */
        .header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #ff2e63, #ff9a00, #ffea00, #00ff88, #00aaff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
            animation: gradient 3s linear infinite;
        }
        
        .subtitle {
            font-size: 1.8rem;
            color: #ffafcc;
            margin-top: 10px;
        }
        
        /* ========== 计数器 ========== */
        .counters {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .counter {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 180px;
        }
        
        .counter i {
            font-size: 1.2rem;
        }
        
        .counter-value {
            margin-left: auto;
            font-weight: bold;
            color: #ff2e63;
        }
        
        /* ========== 主要内容 ========== */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        
        /* ========== 消息框 ========== */
        .message-box {
            flex: 1;
            min-width: 300px;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }
        
        .message-text {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 25px;
        }
        
        .message-text p {
            margin-bottom: 15px;
        }
        
        .signature {
            text-align: right;
            font-size: 1.4rem;
            font-style: italic;
            color: #ff2e63;
            font-weight: bold;
        }
        
        /* ========== 交互区域 ========== */
        .interactive-area {
            flex: 1;
            min-width: 300px;
            max-width: 600px;
        }
        
        /* ========== 按钮网格 ========== */
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .btn {
            background: linear-gradient(135deg, rgba(255, 46, 99, 0.2), rgba(255, 154, 0, 0.2));
            border: 1px solid rgba(255, 46, 99, 0.3);
            border-radius: 15px;
            color: white;
            padding: 20px 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 46, 99, 0.3);
            background: linear-gradient(135deg, rgba(255, 46, 99, 0.3), rgba(255, 154, 0, 0.3));
            border-color: rgba(255, 46, 99, 0.5);
        }
        
        .btn i {
            font-size: 1.8rem;
        }
        
        /* ========== 游戏区域 ========== */
        .game-area {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .game-title {
            font-size: 1.5rem;
            color: #00ff88;
            margin-bottom: 10px;
        }
        
        #gameCanvas {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin: 15px 0;
            cursor: pointer;
        }
        
        /* ========== 设置面板 ========== */
        .settings-panel {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-title {
            font-size: 1.5rem;
            color: #9d4edd;
            margin-bottom: 20px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ========== 音乐播放器 ========== */
        .music-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .music-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ========== 成就通知 ========== */
        .achievement-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9));
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.5s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .achievement-notification.show {
            transform: translateX(0);
        }
        
        /* ========== 动画定义 ========== */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* ========== 响应式设计 ========== */
        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .subtitle { font-size: 1.4rem; }
            .counters { position: relative; flex-direction: row; flex-wrap: wrap; }
            .counter { min-width: 140px; }
            .main-content { flex-direction: column; }
            .btn-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .btn-grid { grid-template-columns: 1fr; }
            .btn { padding: 15px; min-height: 100px; }
        }
    </style>
</head>
<body>
    <!-- 加载界面 -->
    <div id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">加载爱的烟火...</div>
        <div class="loader-progress">
            <div class="loader-progress-bar" id="progressBar"></div>
        </div>
    </div>

    <!-- 粒子背景 -->
    <div id="particles-bg"></div>

    <!-- 计数器 -->
    <div class="counters">
        <div class="counter">
            <i class="fas fa-heart" style="color:#ff2e63;"></i>
            <span>爱心</span>
            <span class="counter-value" id="heartCount">0</span>
        </div>
        <div class="counter">
            <i class="fas fa-fireworks" style="color:#ff9a00;"></i>
            <span>烟花</span>
            <span class="counter-value" id="fireworksCount">0</span>
        </div>
        <div class="counter">
            <i class="fas fa-gamepad" style="color:#00ff88;"></i>
            <span>分数</span>
            <span class="counter-value" id="gameScore">0</span>
        </div>
    </div>

    <!-- 主内容 -->
    <div class="container" id="mainContainer">
        <div class="header">
            <h1>致我最爱的乖乖 <i class="fas fa-heart" style="color:#ff2e63;"></i> 庄依</h1>
            <div class="subtitle">为你绽放最绚丽的数字烟火</div>
        </div>

        <div class="main-content">
            <!-- 情书区域 -->
            <div class="message-box">
                <div class="message-text" id="messageText">
                    <p>亲爱的乖乖：</p>
                    <p>当烟花在夜空中绽放，每一道光芒都是我想你的瞬间。就像这精心设计的烟花效果，每一颗粒子都承载着我对你的思念，每一次爆炸都是心跳的旋律。</p>
                    <p>看那璀璨的烟火，它们在空中画出的轨迹，是我用代码为你写下的情书。红如我炽热的心，金如你灿烂的笑，蓝如我们深情的眼，绿如永恒的希望。</p>
                    <p>每一次烟花的绽放，都是我对你爱的宣言。它们会闪烁、会旋转、会画出心形，就像我对你的爱，永远充满惊喜和浪漫。</p>
                </div>
                <div class="signature">—— 永远为你绽放的人</div>
                
                <div style="margin-top: 25px;">
                    <textarea id="customMessage" 
                              placeholder="在这里写下你想说的话..." 
                              rows="3"
                              style="width:100%; padding:15px; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); border-radius:10px; color:white; margin-bottom:15px;"></textarea>
                    <button class="btn" id="updateMessage" style="width:100%;">
                        <i class="fas fa-paper-plane"></i>
                        <span>更新情书</span>
                    </button>
                </div>
            </div>

            <!-- 交互区域 -->
            <div class="interactive-area">
                <!-- 烟花控制 -->
                <div class="btn-grid">
                    <button class="btn" id="heartMode">
                        <i class="fas fa-heart"></i>
                        <span>心形烟花</span>
                    </button>
                    <button class="btn" id="rainbowMode">
                        <i class="fas fa-rainbow"></i>
                        <span>彩虹烟花</span>
                    </button>
                    <button class="btn" id="fireworksMode">
                        <i class="fas fa-fireworks"></i>
                        <span>烟花表演</span>
                    </button>
                    <button class="btn" id="loveRain">
                        <i class="fas fa-cloud-rain"></i>
                        <span>爱心雨</span>
                    </button>
                    <button class="btn" id="nameFireworks">
                        <i class="fas fa-signature"></i>
                        <span>名字烟花</span>
                    </button>
                    <button class="btn" id="spiralFireworks">
                        <i class="fas fa-sync-alt"></i>
                        <span>螺旋烟花</span>
                    </button>
                    <button class="btn" id="clearHearts">
                        <i class="fas fa-trash"></i>
                        <span>清空效果</span>
                    </button>
                </div>

                <!-- 游戏区域 -->
                <div class="game-area">
                    <div class="game-title">捕捉爱心游戏</div>
                    <p style="margin-bottom: 15px; opacity: 0.9;">点击爱心获得分数，30秒内尽可能多地捕捉爱心！</p>
                    
                    <canvas id="gameCanvas"></canvas>
                    
                    <div style="display: flex; justify-content: space-between; margin: 15px 0;">
                        <div>分数: <span id="scoreValue">0</span></div>
                        <div>时间: <span id="timeValue">30</span>秒</div>
                    </div>
                    
                    <button class="btn" id="startGame" style="width:100%;">
                        <i class="fas fa-play"></i>
                        <span>开始游戏</span>
                    </button>
                </div>

                <!-- 设置面板 -->
                <div class="settings-panel">
                    <div class="settings-title">特效设置</div>
                    
                    <div class="setting-item">
                        <span>粒子密度</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="particleDensity" min="10" max="100" value="40" style="width: 120px;">
                            <span id="densityValue">40</span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <span>音效</span>
                        <label style="cursor: pointer;">
                            <input type="checkbox" id="soundToggle" checked style="margin-right: 5px;">
                            开启
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <span>自动烟花</span>
                        <label style="cursor: pointer;">
                            <input type="checkbox" id="autoFireworksToggle" style="margin-right: 5px;">
                            开启
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <span>漂浮爱心</span>
                        <label style="cursor: pointer;">
                            <input type="checkbox" id="floatHeartsToggle" checked style="margin-right: 5px;">
                            开启
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 音乐播放器 -->
    <div class="music-player">
        <div style="min-width: 120px;" id="musicInfo">浪漫音乐</div>
        <button class="music-btn" id="playPause">
            <i class="fas fa-play"></i>
        </button>
        <button class="music-btn" id="muteBtn">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>

    <!-- 烟花画布 -->
    <canvas id="fireworksCanvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:5;"></canvas>

    <!-- 使用CDN引入粒子库 -->
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <script>
        // ========== 第一阶段：立即显示并加载基础功能 ==========
        console.log("开始加载...");
        
        // 更新加载进度
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
        }
        
        // 立即开始显示进度
        updateProgress(10);
        
        // 基础状态管理
        const appState = {
            heartCount: 0,
            fireworksCount: 0,
            gameScore: 0,
            gameActive: false,
            gameTime: 30,
            isPlaying: false,
            isMuted: false,
            achievements: [],
            autoFireworks: false
        };
        
        // 立即更新计数器
        updateProgress(20);
        
        // ========== 第二阶段：初始化基础UI ==========
        function initBasicUI() {
            updateProgress(30);
            
            // 初始化计数器显示
            document.getElementById('heartCount').textContent = appState.heartCount;
            document.getElementById('fireworksCount').textContent = appState.fireworksCount;
            document.getElementById('gameScore').textContent = appState.gameScore;
            
            // 初始化基础按钮事件
            const basicButtons = ['heartMode', 'rainbowMode', 'fireworksMode', 'clearHearts', 'updateMessage'];
            basicButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.onclick = function() {
                        console.log(btnId + " 被点击");
                        // 基础响应
                        if (btnId === 'heartMode') createBasicFirework('heart');
                        if (btnId === 'clearHearts') clearEffects();
                    };
                }
            });
            
            updateProgress(40);
            return true;
        }
        
        // ========== 第三阶段：初始化粒子背景 ==========
        function initParticles() {
            updateProgress(50);
            
            // 简单粒子背景
            if (typeof particlesJS !== 'undefined') {
                particlesJS("particles-bg", {
                    particles: {
                        number: { value: 40, density: { enable: true, value_area: 800 } },
                        color: { value: "#ff2e63" },
                        shape: { type: "circle" },
                        opacity: { value: 0.3, random: true },
                        size: { value: 3, random: { enable: true, minimumValue: 1 } },
                        line_linked: { 
                            enable: true, 
                            distance: 150, 
                            color: "#ffffff", 
                            opacity: 0.1, 
                            width: 1 
                        },
                        move: { 
                            enable: true, 
                            speed: 1.5, 
                            direction: "none", 
                            random: true,
                            out_mode: "out"
                        }
                    }
                });
            }
            
            updateProgress(60);
            return true;
        }
        
        // ========== 第四阶段：初始化烟花系统 ==========
        class SimpleFireworkSystem {
            constructor() {
                this.canvas = document.getElementById('fireworksCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }
            
            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }
            
            createParticle(x, y, options = {}) {
                const colors = options.colors || ['#ff2e63', '#ff9a00', '#00ff88', '#00aaff'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                this.particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * (options.speed || 5),
                    vy: (Math.random() - 0.5) * (options.speed || 5),
                    radius: options.radius || 2 + Math.random() * 3,
                    color: color,
                    alpha: 1,
                    life: 100,
                    gravity: options.gravity || 0.05
                });
            }
            
            update() {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    
                    p.vy += p.gravity;
                    p.x += p.vx;
                    p.y += p.vy;
                    
                    p.life--;
                    p.alpha = p.life / 100;
                    
                    if (p.life <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
            }
            
            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (const p of this.particles) {
                    this.ctx.globalAlpha = p.alpha;
                    this.ctx.fillStyle = p.color;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                
                this.ctx.globalAlpha = 1;
            }
            
            animate() {
                this.update();
                this.render();
                requestAnimationFrame(() => this.animate());
            }
            
            createHeart(x, y) {
                for (let i = 0; i < 100; i++) {
                    const t = (i / 100) * Math.PI * 2;
                    const px = 16 * Math.pow(Math.sin(t), 3);
                    const py = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                    
                    this.createParticle(x + px * 3, y + py * 3, {
                        colors: ['#ff2e63', '#ff6b9d'],
                        speed: 0.5,
                        gravity: 0.01
                    });
                }
            }
            
            createExplosion(x, y, type = 'romantic') {
                const colorSchemes = {
                    romantic: ['#ff2e63', '#ff6b9d', '#ffafcc'],
                    rainbow: ['#ff2e63', '#ff9a00', '#ffea00', '#00ff88', '#00aaff'],
                    gold: ['#ffd700', '#ffed4e', '#fff9aa']
                };
                
                const colors = colorSchemes[type] || colorSchemes.romantic;
                
                for (let i = 0; i < 80; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 2 + Math.random() * 3;
                    
                    this.createParticle(x, y, {
                        colors: colors,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        speed: 0,
                        gravity: 0.05
                    });
                }
            }
            
            clear() {
                this.particles = [];
            }
        }
        
        function initFireworks() {
            updateProgress(70);
            
            // 创建烟花系统
            window.fireworkSystem = new SimpleFireworkSystem();
            window.fireworkSystem.animate();
            
            // 点击页面创建烟花
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.btn') && !e.target.closest('.music-btn')) {
                    window.fireworkSystem.createExplosion(e.clientX, e.clientY);
                    appState.fireworksCount++;
                    updateCounters();
                }
            });
            
            updateProgress(80);
            return true;
        }
        
        // ========== 第五阶段：初始化完整功能 ==========
        function initCompleteFeatures() {
            updateProgress(85);
            
            // 初始化游戏
            initGame();
            
            // 初始化音乐
            initMusic();
            
            // 初始化设置
            initSettings();
            
            // 初始化所有按钮
            initAllButtons();
            
            updateProgress(95);
            return true;
        }
        
        // 初始化游戏
        function initGame() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const gameHearts = [];
            
            // 创建游戏爱心
            function createGameHeart() {
                return {
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: 20,
                    color: ['#ff2e63', '#ff9a00', '#00ff88'][Math.floor(Math.random() * 3)],
                    speed: 1 + Math.random() * 2
                };
            }
            
            // 初始化爱心
            for (let i = 0; i < 8; i++) {
                gameHearts.push(createGameHeart());
            }
            
            // 游戏循环
            function gameLoop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                for (const heart of gameHearts) {
                    // 移动
                    heart.x += Math.sin(Date.now() / 1000 + heart.x) * 0.5;
                    heart.y += Math.cos(Date.now() / 1000 + heart.y) * 0.5;
                    
                    // 边界检查
                    if (heart.x < 0 || heart.x > canvas.width) heart.speed *= -1;
                    if (heart.y < 0 || heart.y > canvas.height) heart.speed *= -1;
                    
                    // 绘制爱心
                    ctx.fillStyle = heart.color;
                    ctx.beginPath();
                    ctx.arc(heart.x, heart.y, heart.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 绘制爱心图标
                    ctx.font = "20px FontAwesome";
                    ctx.fillText("❤", heart.x - 8, heart.y + 6);
                }
                
                requestAnimationFrame(gameLoop);
            }
            
            // 点击事件
            canvas.onclick = function(e) {
                if (!appState.gameActive) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                for (let i = gameHearts.length - 1; i >= 0; i--) {
                    const heart = gameHearts[i];
                    const distance = Math.sqrt(Math.pow(x - heart.x, 2) + Math.pow(y - heart.y, 2));
                    
                    if (distance < heart.radius) {
                        // 增加分数
                        appState.gameScore += 10;
                        document.getElementById('scoreValue').textContent = appState.gameScore;
                        
                        // 创建烟花效果
                        const screenX = rect.left + heart.x;
                        const screenY = rect.top + heart.y;
                        window.fireworkSystem.createExplosion(screenX, screenY);
                        
                        // 移除并添加新的爱心
                        gameHearts.splice(i, 1);
                        gameHearts.push(createGameHeart());
                        
                        // 更新计数器
                        updateCounters();
                        break;
                    }
                }
            };
            
            // 开始游戏按钮
            document.getElementById('startGame').onclick = function() {
                if (appState.gameActive) {
                    // 停止游戏
                    appState.gameActive = false;
                    appState.gameTime = 30;
                    appState.gameScore = 0;
                    document.getElementById('scoreValue').textContent = 0;
                    document.getElementById('timeValue').textContent = 30;
                    this.innerHTML = '<i class="fas fa-play"></i><span>开始游戏</span>';
                } else {
                    // 开始游戏
                    appState.gameActive = true;
                    appState.gameScore = 0;
                    appState.gameTime = 30;
                    document.getElementById('scoreValue').textContent = 0;
                    this.innerHTML = '<i class="fas fa-stop"></i><span>停止游戏</span>';
                    
                    // 游戏计时器
                    const timer = setInterval(() => {
                        if (!appState.gameActive) {
                            clearInterval(timer);
                            return;
                        }
                        
                        appState.gameTime--;
                        document.getElementById('timeValue').textContent = appState.gameTime;
                        
                        if (appState.gameTime <= 0) {
                            appState.gameActive = false;
                            clearInterval(timer);
                            this.innerHTML = '<i class="fas fa-play"></i><span>开始游戏</span>';
                            alert(`游戏结束！你的得分是：${appState.gameScore}`);
                        }
                    }, 1000);
                }
            };
            
            gameLoop();
        }
        
        // 初始化音乐
        function initMusic() {
            const audio = new Audio('https://assets.mixkit.co/music/preview/mixkit-romantic-sunset-687.mp3');
            audio.loop = true;
            audio.volume = 0.4;
            
            document.getElementById('playPause').onclick = function() {
                if (appState.isPlaying) {
                    audio.pause();
                    this.innerHTML = '<i class="fas fa-play"></i>';
                } else {
                    audio.play().catch(e => console.log("音频播放失败:", e));
                    this.innerHTML = '<i class="fas fa-pause"></i>';
                }
                appState.isPlaying = !appState.isPlaying;
            };
            
            document.getElementById('muteBtn').onclick = function() {
                if (appState.isMuted) {
                    audio.volume = 0.4;
                    this.innerHTML = '<i class="fas fa-volume-up"></i>';
                } else {
                    audio.volume = 0;
                    this.innerHTML = '<i class="fas fa-volume-mute"></i>';
                }
                appState.isMuted = !appState.isMuted;
            };
        }
        
        // 初始化设置
        function initSettings() {
            // 粒子密度滑块
            const densitySlider = document.getElementById('particleDensity');
            densitySlider.oninput = function() {
                document.getElementById('densityValue').textContent = this.value;
                // 这里可以重新初始化粒子
            };
            
            // 自动烟花开关
            const autoToggle = document.getElementById('autoFireworksToggle');
            autoToggle.onchange = function() {
                appState.autoFireworks = this.checked;
                if (appState.autoFireworks) {
                    startAutoFireworks();
                }
            };
        }
        
        // 初始化所有按钮
        function initAllButtons() {
            // 心形烟花
            document.getElementById('heartMode').onclick = function() {
                const x = window.innerWidth / 2;
                const y = window.innerHeight / 2;
                window.fireworkSystem.createHeart(x, y);
                appState.fireworksCount++;
                updateCounters();
                unlockAchievement('心形烟花');
            };
            
            // 彩虹烟花
            document.getElementById('rainbowMode').onclick = function() {
                const x = window.innerWidth / 2;
                const y = window.innerHeight / 2;
                window.fireworkSystem.createExplosion(x, y, 'rainbow');
                appState.fireworksCount++;
                updateCounters();
                unlockAchievement('彩虹烟花');
            };
            
            // 烟花表演
            document.getElementById('fireworksMode').onclick = function() {
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const x = 100 + Math.random() * (window.innerWidth - 200);
                        const y = 100 + Math.random() * (window.innerHeight - 200);
                        const types = ['romantic', 'rainbow', 'gold'];
                        const type = types[Math.floor(Math.random() * types.length)];
                        window.fireworkSystem.createExplosion(x, y, type);
                        appState.fireworksCount++;
                        updateCounters();
                    }, i * 300);
                }
                unlockAchievement('烟花表演');
            };
            
            // 爱心雨
            document.getElementById('loveRain').onclick = function() {
                for (let i = 0; i < 30; i++) {
                    setTimeout(() => {
                        const x = Math.random() * window.innerWidth;
                        window.fireworkSystem.createParticle(x, -50, {
                            colors: ['#ff2e63', '#ff6b9d'],
                            speed: 0,
                            vx: 0,
                            vy: 3 + Math.random() * 2,
                            gravity: 0.1
                        });
                    }, i * 100);
                }
                unlockAchievement('爱心雨');
            };
            
            // 清空效果
            document.getElementById('clearHearts').onclick = function() {
                window.fireworkSystem.clear();
            };
            
            // 更新情书
            document.getElementById('updateMessage').onclick = function() {
                const message = document.getElementById('customMessage').value;
                if (message.trim()) {
                    document.getElementById('messageText').innerHTML = `<p>${message.replace(/\n/g, '</p><p>')}</p>`;
                    unlockAchievement('情书作家');
                }
            };
        }
        
        // 自动烟花
        function startAutoFireworks() {
            if (!appState.autoFireworks) return;
            
            function createAutoFirework() {
                if (!appState.autoFireworks) return;
                
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                const types = ['romantic', 'rainbow', 'gold'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                window.fireworkSystem.createExplosion(x, y, type);
                appState.fireworksCount++;
                updateCounters();
                
                setTimeout(createAutoFirework, 2000 + Math.random() * 3000);
            }
            
            createAutoFirework();
        }
        
        // 基础烟花效果
        function createBasicFirework(type) {
            const x = window.innerWidth / 2;
            const y = window.innerHeight / 2;
            
            if (type === 'heart') {
                window.fireworkSystem.createHeart(x, y);
            } else {
                window.fireworkSystem.createExplosion(x, y);
            }
            
            appState.fireworksCount++;
            updateCounters();
        }
        
        // 清空效果
        function clearEffects() {
            window.fireworkSystem.clear();
        }
        
        // 更新计数器
        function updateCounters() {
            document.getElementById('heartCount').textContent = appState.heartCount;
            document.getElementById('fireworksCount').textContent = appState.fireworksCount;
            document.getElementById('gameScore').textContent = appState.gameScore;
        }
        
        // 解锁成就
        function unlockAchievement(name) {
            if (appState.achievements.includes(name)) return;
            
            appState.achievements.push(name);
            const count = appState.achievements.length;
            
            // 显示成就通知
            showAchievementNotification(name, count);
        }
        
        // 显示成就通知
        function showAchievementNotification(name, count) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <i class="fas fa-trophy"></i>
                <div>
                    <strong>成就解锁！</strong>
                    <div>${name} (${count}/10)</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // ========== 主加载流程 ==========
        async function loadApp() {
            try {
                console.log("第1步：初始化基础UI");
                if (!initBasicUI()) throw new Error("基础UI初始化失败");
                
                console.log("第2步：初始化粒子背景");
                if (!initParticles()) throw new Error("粒子背景初始化失败");
                
                console.log("第3步：初始化烟花系统");
                if (!initFireworks()) throw new Error("烟花系统初始化失败");
                
                console.log("第4步：初始化完整功能");
                if (!initCompleteFeatures()) throw new Error("完整功能初始化失败");
                
                // 加载完成
                updateProgress(100);
                
                // 隐藏加载器，显示主内容
                setTimeout(() => {
                    document.getElementById('loader').style.opacity = '0';
                    document.getElementById('loader').style.visibility = 'hidden';
                    
                    document.getElementById('mainContainer').style.opacity = '1';
                    
                    // 解锁初始成就
                    unlockAchievement('页面加载完成');
                    
                    console.log("应用加载完成！");
                }, 500);
                
            } catch (error) {
                console.error("加载失败:", error);
                document.getElementById('loader-text').textContent = "加载失败，请刷新页面";
            }
        }
        
        // 立即开始加载
        window.addEventListener('DOMContentLoaded', loadApp);
        
        // 确保页面显示
        window.addEventListener('load', function() {
            console.log("页面完全加载");
        });
    </script>
</body>
</html>